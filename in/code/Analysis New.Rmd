---
title: "Analysis New"
author: "Sebastian Sternberg"
date: "16 9 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())

require(magrittr)
require(dplyr)
require(ggplot2)
require(lubridate)
require(stringi)
require(stringr)
require(strex) #regex etc.
require(stargazer)
require(ggthemes)


source("in/code/functions.R") #help functions

```


Read both data sets:

```{r}
d <- read.csv("in/prepareddata/final_dataset.csv", encoding = "UTF-8")
full <- read.csv("in/prepareddata/full_dataset.csv")

#Because the court might have not uploaded all cases so far, we just look at the end of 2018 (31.12.2018)

d <- d %>% filter(year < 2019) # (just one case dropping out)


#delete cases where all richter were replaced
d$nersetzt <- as.numeric(sapply(d$ersetzt, function(x) length(unlist(richter.split(x)))))
d <- d[d$nersetzt<3,] 


```

Check whether black chamber with Broß, DiFabio, Landau is always a non-critical case:

```{r}

black_chamber_judges <- c("Broß", "DiFabio", "Landau")

d$crit[d$r1_f %in% black_chamber_judges & d$r2_f %in% black_chamber_judges & d$r3_f %in% black_chamber_judges]

#we need to drop these cases because they are by design always non-critical.

d <- d[!(d$r1_f %in% black_chamber_judges & d$r2_f %in% black_chamber_judges & d$r3_f %in% black_chamber_judges), ]


```

Now we have the correct N = 247 of the paper. 


## Descriptives paper:


```{r}

#full data set without 2019
nrow(full[full$year < 2019, ])

#Distribution of critical cases:

table(d$critical)
table(d$gv_viol)


```



## EDA

How many drops overall:

```{r}

bla <- d%>% 
  group_by(year)%>%
  summarise(freq=n())

#plot

ggplot(bla, aes(year, freq)) + 
  geom_bar(stat="identity") + theme_tufte()


```

Other descriptives:


```{r}
df <- full

df$year <- year(df$date)
df$month <- month(df$date) %>% as.factor()
df$weekday <- wday(df$date, label = T)

#do the same for the analysis data set:

d$year <- year(d$date)
d$month <- month(d$date) %>% as.factor()
d$weekday <- wday(d$date, label = T)



```


```{r}

#year by Senate chamber


count_pct <- function(df) {
  return(
    df %>%
      tally %>% 
      mutate(n_pct = 100*n/sum(n))
  )
}

df$kammer <- as.factor(df$kammer)
df_senat1 <- df %>% filter(senat == 1) %>% group_by(year, kammer) %>% count_pct()
df_senat2 <- df %>% filter(senat == 2) %>% group_by(year, kammer) %>% count_pct()


# outfolder <- "C:/Users/ssternbe/Dropbox/Kaggle/Scraper_GFCC_Decisions/scraper-decisions-German-Federal-Constitutional-Court/out/figures/"
# 
# pdf(paste0(outfolder, "/","perc_Senate1byChamber.pdf"))



ggplot(df_senat1, aes(x = year, y=n_pct, fill=kammer)) + 
    geom_bar(position="fill", stat="identity") + labs(title = "Senate 1", fill="Chamber") + 
  theme_tufte()


ggplot(df_senat2, aes(x = year, y=n_pct, fill=kammer)) + 
    geom_bar(position="fill", stat="identity") + labs(title = "Senate 2", fill = "Chamber")+
  theme_tufte()

```

by weekday
```{r}

ggplot(tally(group_by(df, weekday)),
    aes(x = weekday, y = n)) +
    geom_bar(stat="identity") + theme_tufte()


ggplot(tally(group_by(df, senat, weekday)),
    aes(x = weekday, y = n, fill = senat)) +
    geom_bar(stat="identity") + labs(fill="Senate")



```

per Month:

```{r}

ggplot(tally(group_by(df, month)),
    aes(x = month, y = n)) +
    geom_bar(stat="identity") + theme_tufte()

```



# Main Analyses


```{r}
# RoP violation rate is larger in critical cases.

summary(m <- glm(gv_viol ~ crit, data=d, family = "binomial"))
summary(m1 <- glm(gv_viol ~ crit, data=d[d$senat==1,], family = "binomial"))
summary(m2 <- glm(gv_viol ~ crit, data=d[d$senat==2,], family = "binomial"))

stargazer(m, m1, m2, 
          #type = "text"
          type = "latex"
          , digits = 1
          , dep.var.caption = "RoP deviation"
          , dep.var.labels.include = F
          , column.labels = c("Both Senates", "Senate 1", "Senate 2")
          , covariate.labels = "Critical case"
          #, star.cutoffs = 0.1
          , summary.stat = "n"
          , omit.stat = c("ll", "aic")
          , model.numbers = F
          #, notes = "$*: p < 0.05$"
          , notes.align = "r"
          , notes.append = FALSE
          , out = "out/main_analysis.tex"
          )

```


Signs point in the predicted direction (violation is more likely in critical cases).

Difference in violation rate between critical and non-critical cases is not statistically significant in Senate 2.

Set up simulation to test whether RoP violation rate is larger in critical cases based on the previous models:

```{r}
require(MASS)
nsim <- 1000

sim <- function(nsim, model, ci=F){
  S <- MASS::mvrnorm(nsim, coef(model), vcov(model))
  logit <- function(x) exp(x)/(1+exp(x))
  s.x <- logit(S%*%c(1,0)); s.x1 <- logit(S%*%c(1,1)) #diff between no critical and critical
  out <- as.numeric(s.x1-s.x) #First Difference = ATE
  if(ci==T) out <- out[out >= quantile(out, .025) & out <= quantile(out, .975)]
  return(out)
}

#sim both:

sim_both <- sim(nsim, m)
sim_1 <- sim(nsim, m1)
sim_2 <- sim(nsim, m2)

sim_data <- cbind.data.frame(sim_both, sim_1, sim_2)

```

Make the corresponding coefficient plot:


```{r}
# Extract coefficient estimates

coef_vec <- apply(sim_data, 2, mean)
  
quantiles_95 <- apply(sim_data, 2, quantile,probs = c(0.025, 0.975))
quantiles_90 <- apply(sim_data, 2, quantile,probs = c(0.05, 0.95))

names_vec <- c("Both Senates", 
                   "Senate 1", 
                   "Senate 2") 

outfolder <- ("~/Dropbox/Papers Mannheim/Paper 2 Kammerbesetzung/Causal Inference Paper/chamber_paper_august2019/chamberGFCC/out")

pdf(paste(outfolder,"/ate_errorbar.pdf",sep = ""), width = 8, height = 6)

#adjust margins:
par(mar  = c(4,7,2,2))

plot(coef_vec, 3:1, 
     pch=19, 
     cex=.8, 
     axes=F, 
     ylab="", 
     xlab="ATE\nDifference in RoP deviation probability (non-critical - critical cases)", 
     xlim=c(-0.5, 0.7))
axis(1)
axis(2, at=3:1, label=names_vec, col="white", las = 1)
abline(v=0, lty=2) # add zero reference line

#plot 95% CIs
segments(quantiles_95[1, ],  3:1, quantiles_95[2, ], length(coef_vec):1, lwd = 1) # add confidence intervals

#add 90% CIs
segments(quantiles_90[1, ],  3:1, quantiles_90[2, ], length(coef_vec):1, lwd = 3) # add confidence intervals

dev.off()


```


## When only looking at decisions which are **not** Einstweilige Anordnung (BvQs):

We use the AZ (BvQ) as an approximation of a BvQ. Note that it can also be the case that BvRs are part of a Einstweilige Anordnung. 


```{r}

summary(m_nobvq <- glm(gv_viol ~ crit, data=d[d$anordnung == 0, ], family = "binomial"))
summary(m1_nobvq <- glm(gv_viol ~ crit, data=d[d$senat==1 & d$anordnung == 0, ], family = "binomial"))
summary(m2_nobvq <- glm(gv_viol ~ crit, data=d[d$senat==2 & d$anordnung == 0, ], family = "binomial"))

```

Simulate and make coef plot:

```{r}

sim_both <- sim(nsim, m_nobvq )
sim_1 <- sim(nsim, m1_nobvq)
sim_2 <- sim(nsim, m2_nobvq)

sim_data <- cbind.data.frame(sim_both, sim_1, sim_2)

coef_vec <- apply(sim_data, 2, mean)
  
quantiles_95 <- apply(sim_data, 2, quantile,probs = c(0.025, 0.975))
quantiles_90 <- apply(sim_data, 2, quantile,probs = c(0.05, 0.95))

names_vec <- c("Both Senates", 
                   "Senate 1", 
                   "Senate 2") 

pdf(paste(outfolder,"/ate_errorbar_noBvQ.pdf",sep = ""), width = 8, height = 6)

#adjust margins:
par(mar  = c(4,7,2,2))

plot(coef_vec, 3:1, 
     pch=19, 
     cex=.8, 
     axes=F, 
     ylab="", 
     xlab="ATE (without BvQ)\nDifference in RoP deviation probability (non-critical - critical cases)", 
     xlim=c(-0.5, 0.7))
axis(1)
axis(2, at=3:1, label=names_vec, col="white", las = 1)
abline(v=0, lty=2) # add zero reference line

#plot 95% CIs
segments(quantiles_95[1, ],  3:1, quantiles_95[2, ], length(coef_vec):1, lwd = 1) # add confidence intervals

#add 90% CIs
segments(quantiles_90[1, ],  3:1, quantiles_90[2, ], length(coef_vec):1, lwd = 3) # add confidence intervals

dev.off()

```


If it is really that in BvQ cases the logic should not apply (because these are the cases where time is really an issue), then the OI is that the party label heuristic should not work here:


```{r}

summary(m_bvq <- glm(gv_viol ~ crit, data=d[d$anordnung == 1, ], family = "binomial"))
summary(m1_bvq <- glm(gv_viol ~ crit, data=d[d$senat==1 & d$anordnung == 1, ], family = "binomial"))
summary(m2_bvq <- glm(gv_viol ~ crit, data=d[d$senat==2 & d$anordnung == 1, ], family = "binomial"))

```

None of the models is sign. This means that in BvQ cases, judges do not have the time/mind to take the party labels into account. 


## Check Presidents in Chambers (proxy for workload)


```{r}

name_presidents <- c("Voßkuhle", "Papier", "Limbach", "Harbarth", "Kirchhof", "Hassemer", "Seidl")

d$is_presidentinchamber <- ifelse(d$r1_f %in% name_presidents | 
                                  d$r2_f %in% name_presidents|
                                  d$r3_f %in% name_presidents,
                                1, 0)

#conmtrol for it
summary(m <- glm(gv_viol ~ crit+ is_presidentinchamber, data=d, family = "binomial"))
summary(m1 <- glm(gv_viol ~ crit + is_presidentinchamber, data=d[d$senat==1,], family = "binomial"))
summary(m2 <- glm(gv_viol ~ crit + is_presidentinchamber, data=d[d$senat==2,], family = "binomial"))

```

# Check homogenous chambers per RoP

```{r}

col <- read.csv("in/data-input/Liste_Richter_1_utf.csv", sep="^", encoding = "UTF-8")

col$last_name_r <- str_trim(clean.names(col$last_name_r))
col$last_name_r <- str_trim(str_replace_all(col$last_name_r, "\\(|\\)| ", ""))
col$first_name_r <- str_trim(col$first_name_r)

col$party_nom <- factor(col$ticket_r)
levels(col$party_nom) <- c("parteilos", "SPD", "CDU", "FDP", "Grüne", "CSU")

# code binary color
col$red <- NA
col$red[col$party_nom%in%c("CDU", "FDP", "CSU")] <- 0
col$red[col$party_nom%in%c("SPD", "Grüne")] <- 1
col <- col[!is.na(col$red), c("last_name_r", "first_name_r", "party_nom", "red")]

# remove duplicate and irrelevant richter
col <- unique(col)
col <- col[col$last_name_r%in%allr,] # irrelevant previous judges
print(str_c("MISSING JUDGE COLOR: ", allr[!allr%in%col$last_name_r]))
print(str_c("nr of list1-judges have NA color: ", table(!is.na(col$red), exclude = NULL)[2]))

redr <- col$last_name_r[col$red==1]

#code the color of the judges:

is_r1f_red <- ifelse(full$r1_f %in% redr, 1, 0)
is_r2f_red <- ifelse(full$r2_f %in% redr, 1, 0)
is_r3f_red <- ifelse(full$r3_f %in% redr, 1, 0)


check_data <- cbind.data.frame(is_r1f_red, is_r2f_red, is_r3f_red)

check_data$rowsum <- rowSums(check_data)

table(check_data$rowsum)

#There is never a homogenous red chamber, but there are black ones
# If sum is zero then black because then no judge in the chamber would be red == all are black

#There are some black chambers:

full$black_chamber <- ifelse(check_data$rowsum == 0, 1, 0)


check_black_chamber <- full %>% filter(black_chamber == 1)

```

There is one black chamber: Broß DiFabio Landau (2008-2010). 


## How many purely red or black chambers are circumvented by deviation?


- real_c:
which of the judges in the real chamber are red?

eventuell mit grün und gelb schauen. Passt das dann so?

real_c == 0:

real: Kruis Winter Jentsch == alle schwarz

real == 2: 

Kühling Jaeger Steiner == 2 red one black

real == 3:

Limbach Graßhof Sommer == all red





```{r}
#critical cases by deviation:

table(d$crit, d$gv_viol)


df_critical_deviation <- d %>% filter(crit == 1 &  gv_viol == 1)

table(df_critical_deviation$real_c)


df_critical_deviation_notredorblack <- df_critical_deviation[df_critical_deviation$real_c == 1 | df_critical_deviation$real_c == 2, ]

# in 21 cases the deviation lead to a balanced (not fully red or black chamber)

```


Overall, there are three cases where there was a purely black chamber even after deviation (all in Senate 2) and 1 case where there was a purely red chamber even after deviation (also in Senate 2). 



How many did avoid a purely black or red chamber:

```{r}
table(df_critical_deviation_notredorblack$real_c)

#real_c == 1 means a black chamber was avoided, and real_c = 2 means a red chamber was avoided
#10 black chambers are avoided by deviation and 11 red chambers.


#per Senate:

table(df_critical_deviation_notredorblack$real_c[df_critical_deviation_notredorblack$senat == 1])
table(df_critical_deviation_notredorblack$real_c[df_critical_deviation_notredorblack$senat == 2])


```

Gibt es unterschiedlich viele 2L 1R Kammern bzw 2R 1L Kammern in kritischen wie unkritischen Faellen

real_c == 1 = 2R 1 L 
real_c == 2 = 1 R 2L

```{r}

table(d$crit)

prop.table(table(d$real_c[d$crit == 0]))
prop.table(table(d$real_c[d$crit == 1]))

```

Check whether dummy fuerFreitag und Wochenende tatsaechlich vorhersagen, dass es ein critischer oder nichtkritischer case ist:

```{r}

d$friday_weekend <- ifelse(d$weekday == "Sa" | d$weekday == "So" | d$weekday == "Fr", 1, 0)

table(d$crit, d$friday_weekend)

d %>% filter(crit == 1 & friday_weekend == 1) %>% nrow()
d %>% filter(crit == 1 & friday_weekend == 0) %>% nrow()


summary(m_friday <- glm(crit~friday_weekend, d, family = "binomial"))

#check the same for BvQ
summary(m_anordnung <- glm(crit~friday_weekend, d[d$anordnung == 0, ], family = "binomial"))


```


## Balance checks

Does month explain when it comes to a critical case:

```{r}

summary(m_month <- glm(crit ~ month, d, family = "binomial"))
summary(m_month_s1 <- glm(crit ~ month, d[d$senat == 1, ], family = "binomial"))
summary(m_month_s2 <- glm(crit ~ month, d[d$senat == 2, ], family = "binomial"))


```

None of the month variables is significant. This means that month does not explain critical cases. 



Does age explain critical cases? For this, we estimate the age the of the absentee judge(s) at the point in time the decision is made. We use this then as the IV to predict critical cases. 


```{r}


col <- read.csv("in/data-input/Liste_Richter_1_utf.csv", sep="^", encoding = "UTF-8")

col$last_name_r <- str_trim(clean.names(col$last_name_r))
col$last_name_r <- str_trim(str_replace_all(col$last_name_r, "\\(|\\)| ", ""))
col$first_name_r <- str_trim(col$first_name_r)



col$


col$date_birth_r2 <- gsub("\\.", "/", col$date_birth_r)
col$date_birth_r2 <- as.Date(col$date_birth_r2, format = "Y")


```





